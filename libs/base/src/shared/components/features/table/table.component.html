<!-- -- -- -- -- -- --- -- -- -- -- -- -- -- -->
<div class="hidden">
  <mat-icon svgIcon="sort"></mat-icon>
  <mat-icon svgIcon="sort-up"></mat-icon>
  <mat-icon svgIcon="sort-down"></mat-icon>
</div>
<!-- Preload icons for a smoother experience! -->

<div class="p-1">
  <!-- Header -->
  <div class="flex flex-col gap-y-4 mb-6 pe-4 min-h-[3rem]">
    <!-- Title -->
    <p class="text-2xl text-surface-medium font-medium">{{ options().view?.title }}</p>
    <!-- Second row of header -->
    <div class="flex items-center gap-2 mt-2 flex-wrap">
      <ng-content select="[slot=header-start]"></ng-content>

      <!-- Batch Actions -->
      <ng-container *ngIf="options().batchActions?.length">
        <ui-field
          class="w-full max-w-[12rem]"
          [control]="batchActionControl"
          controlType="select"
          [items]="batchActions()"
          [searchable]="false"
          label="عمل مورد نیاز"
          placeholder="انتخاب"
          [hideError]="true"
        ></ui-field>
        <ui-button
          class="h-12"
          (onClick)="onBatchActionApply()"
          [disabled]="!batchActionControl.value || !options().selectionModel!.hasSelection()"
          >اعمال</ui-button
        >
        <span *ngIf="options().selectionModel?.selectedCount() ?? 0" class="font-medium"
          ><span class="mx-1">{{ options().selectionModel?.selectedCount() }}</span> از
          <span class="mx-1">{{ totalItems() }}</span> انتخاب شده است</span
        >
      </ng-container>
      <div class="flex-auto"><!-- Spacer --></div>
      <!-- Other buttons -->
      <ui-button
        *ngIf="options().export"
        uiPermissionHide
        class="h-12"
        appearance="text"
        (onClick)="onExport($event)"
        icon="excel-file"
        action="export"
      >
        <span class="mr-1">خروجی اکسل</span>
      </ui-button>
      <ui-button
        *ngIf="options().print"
        uiPermissionHide
        class="h-12"
        appearance="text"
        (onClick)="onPrint($event)"
        icon="print"
        action="print"
      >
        <span class="mr-1">پرینت</span>
      </ui-button>
      <ui-button
        *ngIf="options().events?.add"
        uiPermissionHide
        #MenuTriggerAddButton="matMenuTrigger"
        [matMenuTriggerFor]="null"
        class="h-12"
        (onClick)="onAdd()"
        icon="plus"
        action="create"
      >
        {{ options().view?.addButtonText ?? ADD_TEXT + ' ' + options().view?.itemName }}
      </ui-button>

      <ui-button
        icon="refresh"
        class="h-12"
        appearance="text"
        [disabled]="loading()"
        (onClick)="onRefresh()"
      ></ui-button>

      <ng-content select="[slot=header]"></ng-content>
    </div>
  </div>

  <!-- Body -->
  <div class="relative overflow-auto bg-neutral-99 border border-surface-container-highest rounded-1 table-shadow">
    <div class="table-loader {{ loading() ? 'is-visible' : '' }}">
      <feature-table-filter-bar
        *ngIf="hasFilter()"
        class="{{ !isFirstLoad() ? 'opacity-0 pointer-events-none' : '' }}"
      ></feature-table-filter-bar>
      <div *ngIf="loading()" class="table-container table-skeleton relative">
        <table class="table">
          <thead class="{{ !isFirstLoad() ? 'opacity-0 pointer-events-none' : '' }}">
            <tr class="mat-mdc-header-row mdc-data-table__header-row cdk-header-row">
              <th></th>
            </tr>
          </thead>
          <tbody class="mdc-data-table__content relative">
            <tr class="absolute left-0 right-0 top-0">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            </tr>
            <tr
              *forNumber="8"
              class="mat-mdc-row mdc-data-table__row cdk-row feature-table-row {{
                !isFirstLoad() ? 'bg-transparent' : ''
              }}"
            >
              <td>
                <ui-skeleton class="bg-inherit"></ui-skeleton>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Current Filters Bar -->
    <feature-table-filter-bar *ngIf="hasFilter()" [filterModel]="options().filterModel!"></feature-table-filter-bar>
    <div #Table class="table-container {{ loading() ? 'opacity-50' : '' }}">
      <!-- Table -->
      <table [dataSource]="dataSource" [trackBy]="trackByItem" mat-table class="table">
        <!-- Selection (Checkbox) Define -->
        <feature-table-col-selection
          [options]="options()"
          (onSelect)="onItemSelection($event.row.originalItem, $event.state)"
          (onSelectAll)="onHeaderSelection($event)"
        ></feature-table-col-selection>

        <!-- Index Define -->
        <feature-table-col-index [options]="options()" [startIndex]="Pagination.startIndex()"></feature-table-col-index>

        <!-- Other cols define -->
        @for (col of columns(); track col.prop) {
          <feature-table-col-default
            [options]="options()"
            [col]="col"
            (onRowClick)="onRowClick($any($event))"
          ></feature-table-col-default>
        }

        <!-- Actions Define -->
        <feature-table-col-action
          #ActionCol
          [options]="options()"
          [actions]="actions()"
          (onAction)="onAction($event.row, $event.action, $event.trigger, $event.clickEvent)"
        ></feature-table-col-action>

        <!-- Columns registration -->
        <tr mat-header-row *matHeaderRowDef="columnsLabels()"></tr>

        <!-- Rows registration -->
        <tr
          class="feature-table-row {{ $any(highlightedRows())[row.id] ? 'highlighted' : '' }}"
          mat-row
          *matRowDef="let row; let col; columns: columnsLabels()"
          [attr.data-id]="row.originalItem.id"
        ></tr>
      </table>
    </div>
    <div class="empty:hidden px-12 py-3 border-t border-inherit flex gap-16">
      <ng-content select="[slot=footer]"></ng-content>
    </div>
  </div>
  <ui-pagination
    #Pagination
    [size]="paginationOptions()?.size"
    [total]="totalItems()"
    [autoHide]="paginationOptions()?.autoHide ?? false"
    (onUpdate)="onPaginate()"
    class="{{ !paginationOptions() ? 'hidden' : '' }}"
  ></ui-pagination>
</div>

<!-- Menu used for the Add/Edit action -->
<feature-table-form-menu #FormMenu [options]="options()"></feature-table-form-menu>

<!-- Print -->
<feature-printable-table #PrintableTable></feature-printable-table>
