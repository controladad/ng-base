<ng-container *ngIf="{ isDesktop: screenDetector.isDesktop$ | async } as screen">
  <div class="app-topbar w-full flex absolute left-0 right-0 top-0 z-10 pe-4">
    <div class="flex gap-6 w-full h-full self-center">
      <ng-container *ngIf="screen.isDesktop" [ngTemplateOutlet]="TopbarTabbedItems"></ng-container>
      <ng-container
        *ngIf="!screen.isDesktop"
        [ngTemplateOutlet]="NavButton"
        [ngTemplateOutletContext]="{ class: 'self-center' }"
      ></ng-container>
      <div class="flex-auto"><!-- Spacer --></div>
      <div class="flex items-center flex-none gap-4 me-12 empty:hidden">
        <ng-content select="[slot=header]"></ng-content>
      </div>
    </div>
    <ng-container *ngIf="screen.isDesktop" [ngTemplateOutlet]="SoftLoader"></ng-container>
  </div>
  <mat-sidenav-container
    style="z-index: initial"
    class="app-container h-full {{ sidenavOpened() ? 'opened' : '' }}"
    [hasBackdrop]="true"
    (backdropClick)="sidenavOpened.set(false)"
  >
    <mat-sidenav
      class="{{ screen.isDesktop ? 'app-sidebar' : 'app-sidebar-mobile' }} bg-surface-1 pe-2"
      [mode]="screen.isDesktop ? 'push' : 'over'"
      [opened]="sidenavOpened()"
      (opened)="sidenavOpened.set(true)"
      (closed)="sidenavOpened.set(false)"
    >
      <ng-container *ngIf="screen.isDesktop" [ngTemplateOutlet]="NavButton"></ng-container>
      <ui-icon
        *ngIf="!screen.isDesktop"
        (onClick)="sidenavOpened.set(false)"
        class="w-12 h-12 text-surface-on-variant"
        size="1.5rem"
        icon="close"
      ></ui-icon>
      <!--    <div class="flex flex-col gap-1 mt-1">-->
      <!--      <ng-container [ngTemplateOutlet]="SidebarItem" [ngTemplateOutletContext]="{item: newIssueItem, class: 'alt'}"></ng-container>-->
      <!--    </div>-->
      <div (click)="onOpenProfile()" class="profile">
        <img [src]="profileUrl()" width="48" height="48" />
      </div>
      <div class="flex flex-col gap-1 gap-y-3 mt-13">
        <ng-container
          *ngFor="let item of routeHelper.routes()"
          [ngTemplateOutlet]="SidebarItem"
          [ngTemplateOutletContext]="{ item }"
        ></ng-container>
      </div>
    </mat-sidenav>
    <mat-sidenav-content class="app-content" style="z-index: initial">
      <div *ngIf="!screen.isDesktop" class="app-topbar-sm flex sticky top-0 z-5">
        <ng-container [ngTemplateOutlet]="TopbarTabbedItems"></ng-container>
        <ng-container [ngTemplateOutlet]="SoftLoader"></ng-container>
      </div>

      <div class="flex flex-col relative w-full h-full overflow-hidden">
        <div class="flex-auto overflow-auto ps-1 pt-4 pb-20 lg:p-4 lg:ps-11 lg:pt-12 lg:pe-16 lg:pb-20">
          <router-outlet></router-outlet>
        </div>
        <ng-content></ng-content>
        <ui-loader-screen [show]="layout.loading()" [errored]="layout.failed()" [z]="9"></ui-loader-screen>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</ng-container>

<ng-template #TopbarTabbedItems>
  <div class="overflow-x-auto pb-0">
    <mat-button-toggle-group [value]="routeHelper.childPath()" class="topbar-button-group h-full select-none">
      <mat-button-toggle
        *ngFor="let item of layout.topbarItems(); index as index"
        [value]="item.path"
        (change)="$event.value ? childNavigate(item) : null"
      >
        <div class="flex flex-col w-full h-full pt-1.5 items-center">
          <mat-icon
            class="text-inherit"
            [svgIcon]="
              (item.icon?.active && routeHelper.childPath() === item.path ? item.icon?.active : item.icon?.default) ??
              ''
            "
          ></mat-icon>
          <span class="text-inherit leading-0 mt-4">{{ item.label }}</span>
        </div>
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>
</ng-template>

<ng-template #SoftLoader>
  <mat-progress-bar
    *ngIf="layout.softLoading()"
    class="absolute -bottom-1 left-0 right-0"
    mode="indeterminate"
  ></mat-progress-bar>
</ng-template>

<ng-template #NavButton let-class="class">
  <ui-icon
    (onClick)="sidenavOpened.set(!sidenavOpened())"
    class="w-12 h-12 text-surface-on-variant mr-0 md:mr-1 {{ !sidenavOpened() ? 'rounded-10' : '' }} {{ class ?? '' }}"
    size="1.5rem"
    [icon]="sidenavOpened() ? 'close' : 'nav'"
  ></ui-icon>
</ng-template>

<ng-template #SidebarItem let-item="item" let-class="class">
  <ng-container *ngLet="routeHelper.parentPath() === item.path as isActive">
    <div
      role="button"
      tabindex="0"
      (click)="parentNavigate(item)"
      (keydown.enter)="parentNavigate(item)"
      class="ui-sidebar-item {{ isActive ? 'active' : '' }} {{ sidenavOpened() ? 'expand' : '' }} {{ class ?? '' }}"
    >
      <mat-icon
        class="ui-sidebar-item-icon flex-none {{ sidenavOpened() ? 'ms-4' : 'mx-auto' }}"
        [svgIcon]="(item.icon?.active && isActive ? item.icon?.active : item.icon?.default) ?? ''"
      ></mat-icon>
      <div class="ui-sidebar-item-content">
        <span>{{ item.label }}</span>
      </div>
    </div>
  </ng-container>
</ng-template>
